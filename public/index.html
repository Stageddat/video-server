<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Video Hosting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>üé• Video Hosting</h1>
      <div id="notification"></div>
      <form id="uploadForm">
        <input
          type="password"
          id="password"
          placeholder="üîê Password"
          required
        />
        <input
          type="file"
          name="video"
          id="videoFile"
          accept="video/*"
          required
        />
        <input
          type="text"
          id="customName"
          placeholder="üìù Custom name (optional)"
        />
        <div id="status"></div>
        <div id="progress-container">
          <div id="progress-bar" style="width: 0%"></div>
        </div>
        <button type="submit" id="submitBtn">
          <span>üì§ Upload Video</span>
        </button>
      </form>

      <div id="videos">
        <h2>üìπ My Videos</h2>
        <div id="videoList"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById("uploadForm");
      const passwordInput = document.getElementById("password");
      const progressBar = document.getElementById("progress-bar");
      const progressContainer = document.getElementById("progress-container");
      const customNameInput = document.getElementById("customName");
      const notification = document.getElementById("notification");
      const status = document.getElementById("status");
      const submitBtn = document.getElementById("submitBtn");
      const videoFileInput = document.getElementById("videoFile");

      let currentProcessedFilename = null; // Para guardar el nombre del archivo procesado para renombrar
      let sseEventSource = null; // Para la conexi√≥n SSE

      function handleAuthError(errorType, message) {
        passwordInput.classList.remove("input-error");
        passwordInput.classList.add("input-error");
        showNotification(message, true, "auth");
        passwordInput.value = "";
        setTimeout(() => passwordInput.focus(), 100);
        setTimeout(() => passwordInput.classList.remove("input-error"), 3000);
      }

      function resetFormState() {
        submitBtn.disabled = false;
        submitBtn.innerHTML = "<span>üì§ Upload Video</span>";
        progressBar.style.width = "0%";
        progressBar.style.background =
          "linear-gradient(90deg, #667eea, #764ba2)";
        progressContainer.style.display = "none"; // Ocultar barra al inicio y fin
        hideStatus();
        form.reset(); // Esto tambi√©n limpia el input de archivo
        customNameInput.value = "";
        currentProcessedFilename = null;
        if (sseEventSource) {
          sseEventSource.close();
          sseEventSource = null;
        }
      }

      // Inicialmente ocultar la barra de progreso
      progressContainer.style.display = "none";

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const file = videoFileInput.files[0];
        if (!file) {
          showNotification("‚ö†Ô∏è Please select a video file.", true);
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = "<span>‚è≥ Preparing...</span>";
        progressContainer.style.display = "block"; // Mostrar barra
        progressBar.style.width = "0%";
        progressBar.style.background =
          "linear-gradient(90deg, #667eea, #764ba2)"; // Reset color
        showStatus("Starting upload...", "info");
        currentProcessedFilename = null;
        if (sseEventSource) sseEventSource.close();

        const formData = new FormData();
        formData.append("video", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload", true);
        xhr.setRequestHeader("Authorization", passwordInput.value);

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            progressBar.style.width = percent + "%";
            showStatus(
              `Uploading file... ${Math.round(percent)}%`,
              "processing"
            );
          }
        };

        xhr.onload = async function () {
          submitBtn.innerHTML = "<span>‚è≥ Processing...</span>"; // Cambiar texto del bot√≥n despu√©s de subir

          try {
            const response = JSON.parse(xhr.responseText);

            if (xhr.status === 401) {
              if (response.error === "MISSING_PASSWORD")
                handleAuthError(
                  "MISSING_PASSWORD",
                  "üîí Please enter a password"
                );
              else if (response.error === "WRONG_PASSWORD")
                handleAuthError("WRONG_PASSWORD", "‚ùå Wrong password");
              else handleAuthError("AUTH_ERROR", "üö´ Authentication error");
              showStatus("‚ùå Authentication failed", "error");
              progressBar.style.background = "#ef4444";
              resetFormState(); // Parcial, mantener contrase√±a podr√≠a ser √∫til pero por ahora reset completo
              passwordInput.value =
                xhr.status === 401 ? "" : passwordInput.value; // Limpiar solo si es error de pass
              submitBtn.disabled = false;
              submitBtn.innerHTML = "<span>üì§ Upload Video</span>";
              return;
            }

            if (xhr.status >= 400) {
              // Otros errores del servidor al subir
              showStatus(
                `Error: ${response.message || "Upload failed"}`,
                "error"
              );
              showNotification(
                `‚ùå ${response.message || "Upload failed"}`,
                true
              );
              progressBar.style.background = "#ef4444";
              resetFormState();
              return;
            }

            if (response.success && response.taskId) {
              showStatus(
                "Upload complete. Initializing processing...",
                "processing"
              );
              progressBar.style.width = "100%"; // Upload visualmente completo

              // Iniciar escucha de eventos SSE para el progreso del procesamiento
              sseEventSource = new EventSource(
                `/processing-status/${response.taskId}`
              );

              sseEventSource.onmessage = function (event) {
                const progressData = JSON.parse(event.data);
                // console.log("SSE Data:", progressData);

                if (progressData.stage === "probing") {
                  showStatus(
                    progressData.message || "Analyzing video...",
                    "processing"
                  );
                  progressBar.style.width = "0%"; // Resetear barra para etapa de procesamiento
                } else if (progressData.stage === "probed_success") {
                  showStatus(
                    progressData.message ||
                      "Analysis complete. Starting conversion...",
                    "processing"
                  );
                  progressBar.style.width = "0%"; // O un peque√±o % inicial
                } else if (progressData.stage === "processing") {
                  progressBar.style.width = (progressData.percent || 0) + "%";
                  showStatus(
                    progressData.message ||
                      `Processing... ${progressData.percent || 0}%`,
                    "processing"
                  );
                } else if (progressData.stage === "done") {
                  currentProcessedFilename = progressData.filename;
                  showStatus(
                    progressData.message || "Video processed successfully!",
                    "success"
                  );
                  showNotification(
                    `‚úÖ ${
                      progressData.message || "Video processed successfully!"
                    }`
                  );
                  progressBar.style.width = "100%";
                  progressBar.style.background = "#22c55e";
                  sseEventSource.close();

                  handleRenameAndFinalize();
                } else if (progressData.stage === "error") {
                  showStatus(
                    `Error: ${progressData.error || "Processing failed"}`,
                    "error"
                  );
                  showNotification(
                    `‚ùå ${
                      progressData.error ||
                      "An error occurred during processing."
                    }`,
                    true
                  );
                  progressBar.style.background = "#ef4444";
                  sseEventSource.close();
                  resetFormState(); // Resetear todo
                }
              };

              sseEventSource.onerror = function () {
                showStatus(
                  "Error connecting to processing status updates.",
                  "error"
                );
                showNotification(
                  "üîå Connection error with server for status updates.",
                  true
                );
                progressBar.style.background = "#ef4444";
                sseEventSource.close();
                resetFormState();
              };
            } else {
              // Si /upload no devuelve success o taskId
              showStatus(
                "Error: Could not initialize video processing.",
                "error"
              );
              showNotification(
                `‚ùå ${response.message || "Failed to start processing."}`,
                true
              );
              progressBar.style.background = "#ef4444";
              resetFormState();
            }
          } catch (parseError) {
            console.error(
              "Parse error:",
              parseError,
              "Response text:",
              xhr.responseText
            );
            showStatus("Error processing server response", "error");
            showNotification("‚ùå Error processing server response", true);
            progressBar.style.background = "#ef4444";
            resetFormState();
          }
        };

        xhr.onerror = function () {
          showStatus("‚ùå Connection error during upload", "error");
          showNotification("üîå Connection error with server", true);
          progressBar.style.background = "#ef4444";
          resetFormState();
        };

        xhr.send(formData);
      });

      async function handleRenameAndFinalize() {
        const customName = customNameInput.value.trim();
        if (customName && currentProcessedFilename) {
          showStatus("Renaming file...", "processing");
          try {
            const renameRes = await fetch("/rename", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: passwordInput.value,
              },
              body: JSON.stringify({
                original: currentProcessedFilename,
                newName: customName,
              }),
            });

            // Autenticaci√≥n para renombrar
            if (renameRes.status === 401) {
              const renameAuthError = await renameRes.json();
              if (renameAuthError.error === "WRONG_PASSWORD")
                handleAuthError(
                  "WRONG_PASSWORD",
                  "‚ùå Wrong password for renaming"
                );
              else handleAuthError("AUTH_ERROR", "üö´ Auth error during rename");
              showStatus("‚ùå Rename auth failed", "error");
              // No resetear todo, solo el estado de error de auth
              submitBtn.disabled = false;
              submitBtn.innerHTML = "<span>üì§ Upload Video</span>";
              return; // Detener aqu√≠ para que el usuario pueda reintentar o corregir
            }

            const renameResponse = await renameRes.json();
            if (renameResponse.success) {
              showNotification(`üìù ${renameResponse.message}`);
              currentProcessedFilename = renameResponse.newName; // Actualizar con el nuevo nombre
            } else {
              showNotification(
                `‚ö†Ô∏è Error renaming: ${renameResponse.error}`,
                true
              );
            }
          } catch (renameError) {
            console.error("Rename fetch error:", renameError);
            showNotification(
              "‚ö†Ô∏è Network error while trying to rename file",
              true
            );
          }
        }

        await loadVideos();
        // Resetear completamente despu√©s de un √©xito y posible renombramiento
        setTimeout(() => {
          resetFormState();
        }, 2000); // Un peque√±o delay para que el usuario vea el mensaje final
      }

      function showStatus(message, type) {
        status.textContent = message;
        status.className = `status-${type}`; // Aseg√∫rate de tener clases CSS: status-info, status-processing, status-success, status-error
        status.style.display = "block";
      }

      function hideStatus() {
        status.style.display = "none";
      }

      function showNotification(msg, isError = false, errorType = null) {
        notification.textContent = msg;
        notification.className = "";
        if (isError) {
          notification.className =
            errorType === "auth"
              ? "notification-auth-error"
              : "notification-error";
        } else {
          notification.className = "notification-success"; // Clase para notificaciones de √©xito
        }
        notification.style.display = "block";
        setTimeout(() => {
          notification.style.display = "none";
          notification.className = "";
        }, 5000);
      }

      async function loadVideos() {
        try {
          const res = await fetch("/videos");
          if (!res.ok) {
            throw new Error(`Failed to load videos: ${res.statusText}`);
          }
          const files = await res.json();
          const container = document.getElementById("videoList");
          container.innerHTML = "";

          if (files.length === 0) {
            container.innerHTML =
              "<p style='text-align: center; color: #9ca3af; font-style: italic;'>üìÇ No videos available</p>";
            return;
          }

          files.forEach((file) => {
            const div = document.createElement("div");
            div.className = "video-name"; // Aseg√∫rate que esta clase exista en tu CSS
            const link = document.createElement("a");
            link.href = `/video/${encodeURIComponent(file)}`;
            link.target = "_blank";
            link.innerHTML = `üé¨ ${file}`; // Usar textContent es m√°s seguro si los nombres de archivo pudieran tener HTML
            div.appendChild(link);
            container.appendChild(div);
          });
        } catch (error) {
          console.error("Error loading videos:", error);
          showNotification(
            `‚ùå Error loading video list: ${error.message}`,
            true
          );
        }
      }
      loadVideos();
    </script>
  </body>
</html>
