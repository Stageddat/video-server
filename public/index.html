<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>video hosting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>üé• video hosting</h1>
      <div id="notification"></div>
      <form id="uploadForm">
        <input
          type="password"
          id="password"
          placeholder="üîê password"
          required
        />
        <input type="file" name="video" accept="video/*" required />
        <input
          type="text"
          id="customName"
          placeholder="üìù custom name (optional)"
        />
        <div id="status"></div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <button type="submit" id="submitBtn">
          <span>üì§ upload video</span>
        </button>
      </form>

      <div id="videos">
        <h2>üìπ my videos</h2>
        <div id="videoList"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById("uploadForm");
      const passwordInput = document.getElementById("password");
      const progressBar = document.getElementById("progress-bar");
      const customNameInput = document.getElementById("customName");
      const notification = document.getElementById("notification");
      const status = document.getElementById("status");
      const submitBtn = document.getElementById("submitBtn");

      // Function to handle authentication errors
      function handleAuthError(errorType, message) {
        // Clear input error classes first
        passwordInput.classList.remove("input-error");

        // Add error styling to password input
        passwordInput.classList.add("input-error");

        // Show notification with specific styling
        showNotification(message, true, "auth");

        // Clear password field
        passwordInput.value = "";

        // Focus on password input
        setTimeout(() => {
          passwordInput.focus();
        }, 100);

        // Remove error styling after a few seconds
        setTimeout(() => {
          passwordInput.classList.remove("input-error");
        }, 3000);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fileInput = form.querySelector('input[type="file"]');
        const file = fileInput.files[0];
        if (!file) return;

        // disable form during upload
        submitBtn.disabled = true;
        submitBtn.innerHTML = "<span>‚è≥ processing...</span>";

        // show initial status
        showStatus("uploading file...", "processing");
        progressBar.style.width = "0%";

        const formData = new FormData();
        formData.append("video", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload", true);
        xhr.setRequestHeader("Authorization", passwordInput.value);

        xhr.upload.onprogress = function (e) {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressBar.style.width = percent + "%";
            if (percent < 100) {
              showStatus(
                `uploading file... ${Math.round(percent)}%`,
                "processing"
              );
            } else {
              showStatus("processing and verifying video...", "processing");
            }
          }
        };

        xhr.onload = async function () {
          try {
            const response = JSON.parse(xhr.responseText);

            // Check for authentication errors first
            if (xhr.status === 401) {
              if (response.error === "MISSING_PASSWORD") {
                handleAuthError(
                  "MISSING_PASSWORD",
                  "üîí please enter a password"
                );
              } else if (response.error === "WRONG_PASSWORD") {
                handleAuthError("WRONG_PASSWORD", "‚ùå wrong password");
              } else {
                handleAuthError("AUTH_ERROR", "üö´ authentication error");
              }

              showStatus("‚ùå authentication failed", "error");
              progressBar.style.background = "#ef4444";

              // re-enable form
              submitBtn.disabled = false;
              submitBtn.innerHTML = "<span>üì§ upload video</span>";
              return;
            }

            if (response.success) {
              showStatus("video processed successfully", "success");
              showNotification("‚úÖ video uploaded and processed successfully");
              progressBar.style.width = "100%";
              progressBar.style.background = "#22c55e";

              // try to rename if custom name was provided
              const customName = customNameInput.value.trim();
              if (customName) {
                try {
                  const renameRes = await fetch("/rename", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: passwordInput.value,
                    },
                    body: JSON.stringify({
                      original: response.filename,
                      newName: customName,
                    }),
                  });

                  if (renameRes.status === 401) {
                    const renameError = await renameRes.json();
                    if (renameError.error === "WRONG_PASSWORD") {
                      handleAuthError(
                        "WRONG_PASSWORD",
                        "‚ùå wrong password for renaming"
                      );
                    }
                    return;
                  }

                  const renameResponse = await renameRes.json();
                  if (renameResponse.success) {
                    showNotification("üìù " + renameResponse.message);
                  } else {
                    showNotification(
                      "‚ö†Ô∏è error renaming: " + renameResponse.error,
                      true
                    );
                  }
                } catch (renameError) {
                  showNotification("‚ö†Ô∏è error renaming file", true);
                }
              }

              // reload video list
              await loadVideos();

              // clear form
              form.reset();
              customNameInput.value = "";
            } else {
              // processing error
              showStatus("error: " + response.error, "error");
              showNotification("‚ùå error: " + response.error, true);
              progressBar.style.background = "#ef4444";
            }
          } catch (parseError) {
            showStatus("error processing server response", "error");
            showNotification("‚ùå error processing server response", true);
            progressBar.style.background = "#ef4444";
          }

          // re-enable form
          submitBtn.disabled = false;
          submitBtn.innerHTML = "<span>üì§ upload video</span>";

          // hide progress bar after a few seconds
          setTimeout(() => {
            progressBar.style.width = "0%";
            progressBar.style.background =
              "linear-gradient(90deg, #667eea, #764ba2)";
            hideStatus();
          }, 3000);
        };

        xhr.onerror = function () {
          showStatus("‚ùå connection error", "error");
          showNotification("üîå connection error with server", true);
          submitBtn.disabled = false;
          submitBtn.innerHTML = "<span>üì§ upload video</span>";
          progressBar.style.background = "#ef4444";
        };

        xhr.send(formData);
      });

      function showStatus(message, type) {
        status.textContent = message;
        status.className = `status-${type}`;
        status.style.display = "block";
      }

      function hideStatus() {
        status.style.display = "none";
      }

      function showNotification(msg, isError = false, errorType = null) {
        notification.textContent = msg;
        notification.className = "";

        if (isError) {
          if (errorType === "auth") {
            notification.className = "notification-auth-error";
          } else {
            notification.className = "notification-error";
          }
        }

        notification.style.display = "block";
        setTimeout(() => {
          notification.style.display = "none";
          notification.className = "";
        }, 5000);
      }

      async function loadVideos() {
        try {
          const res = await fetch("/videos");
          const files = await res.json();
          const container = document.getElementById("videoList");
          container.innerHTML = "";

          if (files.length === 0) {
            container.innerHTML =
              "<p style='text-align: center; color: #9ca3af; font-style: italic;'>üìÇ no videos available</p>";
            return;
          }

          files.forEach((file) => {
            const div = document.createElement("div");
            div.className = "video-name";
            const link = document.createElement("a");
            link.href = "/video/" + file;
            link.target = "_blank";
            link.innerHTML = `üé¨ ${file}`;
            div.appendChild(link);
            container.appendChild(div);
          });
        } catch (error) {
          console.error("error loading videos:", error);
          showNotification("‚ùå error loading video list", true);
        }
      }

      // load videos on start
      loadVideos();
    </script>
  </body>
</html>
