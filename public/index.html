<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Hosting Platform</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        line-height: 1.6;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: #ffffff;
        text-align: center;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
      }

      h2 {
        color: #f3f4f6;
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      #uploadForm {
        background: rgba(31, 41, 55, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(75, 85, 99, 0.3);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        margin-bottom: 3rem;
        transition: all 0.3s ease;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }

      #uploadForm:hover {
        transform: translateY(-2px);
        box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.6);
      }

      input[type="file"],
      input[type="password"],
      input[type="text"] {
        width: 100%;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        background: rgba(17, 24, 39, 0.8);
        border: 2px solid rgba(75, 85, 99, 0.4);
        border-radius: 12px;
        color: #f9fafb;
        font-size: 1rem;
        transition: all 0.3s ease;
        outline: none;
      }

      input[type="file"]:focus,
      input[type="password"]:focus,
      input[type="text"]:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: rgba(17, 24, 39, 0.9);
      }

      input::placeholder {
        color: #9ca3af;
      }

      input[type="file"] {
        padding: 1.25rem;
        cursor: pointer;
        background: rgba(55, 65, 81, 0.6);
        border: 2px dashed rgba(102, 126, 234, 0.4);
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      input[type="file"]:hover {
        border-color: #667eea;
        background: rgba(55, 65, 81, 0.8);
      }

      .input-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        background: rgba(17, 24, 39, 0.9) !important;
      }

      button {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      button:hover::before {
        left: 100%;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px -12px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      button:disabled::before {
        display: none;
      }

      #progress-container {
        width: 100%;
        background: rgba(17, 24, 39, 0.8);
        height: 8px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      #progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s ease;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
      }

      #status {
        margin-bottom: 1.5rem;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        font-weight: 600;
        display: none;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .status-processing {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.2),
          rgba(217, 119, 6, 0.2)
        );
        color: #fbbf24;
        border-color: rgba(245, 158, 11, 0.3);
      }

      .status-success {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.2),
          rgba(21, 128, 61, 0.2)
        );
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.3);
      }

      .status-error {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.2),
          rgba(185, 28, 28, 0.2)
        );
        color: #f87171;
        border-color: rgba(239, 68, 68, 0.3);
      }

      #videos {
        background: rgba(31, 41, 55, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(75, 85, 99, 0.3);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }

      #videoList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }

      .video-item {
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(75, 85, 99, 0.3);
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .video-item:hover {
        background: rgba(17, 24, 39, 0.8);
        border-color: #667eea;
        transform: translateY(-5px);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
      }

      .video-thumbnail {
        width: 100%;
        height: 180px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .video-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .video-item:hover .video-thumbnail img {
        transform: scale(1.05);
      }

      .video-thumbnail .placeholder {
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.7);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .play-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .video-item:hover .play-overlay {
        opacity: 1;
      }

      .video-info {
        padding: 1.25rem;
      }

      .video-title {
        color: #e5e7eb;
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        line-height: 1.4;
        display: block;
        word-break: break-word;
        transition: color 0.3s ease;
      }

      .video-title:hover {
        color: #667eea;
      }

      .no-videos {
        text-align: center;
        color: #9ca3af;
        font-style: italic;
        padding: 3rem;
        font-size: 1.2rem;
        background: rgba(17, 24, 39, 0.3);
        border-radius: 12px;
        border: 2px dashed rgba(75, 85, 99, 0.3);
      }

      #notification {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.9),
          rgba(21, 128, 61, 0.9)
        );
        color: white;
        padding: 1rem 1.25rem;
        margin: 1rem 0;
        border-radius: 12px;
        display: none;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        font-weight: 500;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
      }

      .notification-error {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.9),
          rgba(185, 28, 28, 0.9)
        ) !important;
      }

      .notification-auth-error {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.95),
          rgba(185, 28, 28, 0.95)
        ) !important;
        border: 2px solid rgba(239, 68, 68, 0.6) !important;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        20%,
        40%,
        60%,
        80%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 0.5rem;
        }

        h1 {
          font-size: 2rem;
          margin-bottom: 1.5rem;
        }

        h2 {
          font-size: 1.5rem;
          margin-bottom: 1rem;
        }

        #uploadForm,
        #videos {
          padding: 1.5rem;
          border-radius: 16px;
          margin-bottom: 2rem;
        }

        input[type="file"],
        input[type="password"],
        input[type="text"] {
          padding: 0.875rem 1rem;
          margin-bottom: 1.25rem;
          font-size: 16px;
        }

        button {
          padding: 0.875rem 1.5rem;
          font-size: 1rem;
        }

        #videoList {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .video-thumbnail {
          height: 200px;
        }

        .video-info {
          padding: 1rem;
        }

        .video-title {
          font-size: 0.9rem;
        }

        #notification {
          right: 10px;
          left: 10px;
          max-width: none;
        }
      }

      @media (max-width: 480px) {
        h1 {
          font-size: 1.75rem;
        }

        #uploadForm,
        #videos {
          padding: 1.25rem;
          border-radius: 12px;
        }

        input[type="file"],
        input[type="password"],
        input[type="text"] {
          padding: 0.75rem;
          margin-bottom: 1rem;
        }

        button {
          padding: 0.75rem 1.25rem;
        }

        .video-thumbnail {
          height: 160px;
        }
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(17, 24, 39, 0.5);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.6);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.8);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🎥 Video Hosting Platform</h1>

      <div id="notification"></div>

      <form id="uploadForm">
        <input
          type="password"
          id="password"
          placeholder="🔐 Enter Password"
          required
        />
        <input
          type="file"
          name="video"
          id="videoFile"
          accept="video/*"
          required
        />
        <input
          type="text"
          id="customName"
          placeholder="📝 Custom name (optional)"
        />
        <div id="status"></div>
        <div id="progress-container" style="display: none">
          <div id="progress-bar"></div>
        </div>
        <button type="submit" id="submitBtn">
          <span>📤 Upload Video</span>
        </button>
      </form>

      <div id="videos">
        <h2>📹 My Videos</h2>
        <div id="videoList"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById("uploadForm");
      const passwordInput = document.getElementById("password");
      const progressBar = document.getElementById("progress-bar");
      const progressContainer = document.getElementById("progress-container");
      const customNameInput = document.getElementById("customName");
      const notification = document.getElementById("notification");
      const status = document.getElementById("status");
      const submitBtn = document.getElementById("submitBtn");
      const videoFileInput = document.getElementById("videoFile");

      let currentProcessedFilename = null;
      let sseEventSource = null;

      function handleAuthError(errorType, message) {
        passwordInput.classList.remove("input-error");
        passwordInput.classList.add("input-error");
        showNotification(message, true, "auth");
        passwordInput.value = "";
        setTimeout(() => passwordInput.focus(), 100);
        setTimeout(() => passwordInput.classList.remove("input-error"), 3000);
      }

      function resetFormState() {
        submitBtn.disabled = false;
        submitBtn.innerHTML = "<span>📤 Upload Video</span>";
        progressBar.style.width = "0%";
        progressBar.style.background =
          "linear-gradient(90deg, #667eea, #764ba2)";
        progressContainer.style.display = "none";
        hideStatus();
        form.reset();
        customNameInput.value = "";
        currentProcessedFilename = null;
        if (sseEventSource) {
          sseEventSource.close();
          sseEventSource = null;
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const file = videoFileInput.files[0];
        if (!file) {
          showNotification("⚠️ Please select a video file.", true);
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = "<span>⏳ Preparing...</span>";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.style.background =
          "linear-gradient(90deg, #667eea, #764ba2)";
        showStatus("Starting upload...", "processing");
        currentProcessedFilename = null;
        if (sseEventSource) sseEventSource.close();

        const formData = new FormData();
        formData.append("video", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload", true);
        xhr.setRequestHeader("Authorization", passwordInput.value);

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            progressBar.style.width = percent + "%";
            showStatus(
              `Uploading file... ${Math.round(percent)}%`,
              "processing"
            );
          }
        };

        xhr.onload = async function () {
          try {
            const response = JSON.parse(xhr.responseText);

            if (xhr.status === 401) {
              if (response.error === "MISSING_PASSWORD")
                handleAuthError(
                  "MISSING_PASSWORD",
                  "🔒 Please enter a password"
                );
              else if (response.error === "WRONG_PASSWORD")
                handleAuthError("WRONG_PASSWORD", "❌ Wrong password");
              else handleAuthError("AUTH_ERROR", "🚫 Authentication error");
              showStatus("❌ Authentication failed", "error");
              progressBar.style.background = "#ef4444";
              resetFormState();
              passwordInput.value =
                xhr.status === 401 ? "" : passwordInput.value;
              submitBtn.disabled = false;
              submitBtn.innerHTML = "<span>📤 Upload Video</span>";
              return;
            }

            if (xhr.status >= 400) {
              showStatus(
                `Error: ${response.message || "Upload failed"}`,
                "error"
              );
              showNotification(
                `❌ ${response.message || "Upload failed"}`,
                true
              );
              progressBar.style.background = "#ef4444";
              resetFormState();
              return;
            }

            if (response.success && response.taskId) {
              if (
                response.message === "Upload received, file moved directly."
              ) {
                currentProcessedFilename = response.filename || file.name;
                showStatus("Upload complete. File moved directly.", "success");
                showNotification(`✅ ${response.message}`);
                progressBar.style.width = "100%";
                progressBar.style.background = "#22c55e";
                handleRenameAndFinalize();
                return;
              }

              showStatus(
                "Upload complete. Initializing processing...",
                "processing"
              );
              progressBar.style.width = "100%";

              sseEventSource = new EventSource(
                `/processing-status/${response.taskId}`
              );

              sseEventSource.onmessage = function (event) {
                const progressData = JSON.parse(event.data);

                if (progressData.stage === "probing") {
                  showStatus(
                    progressData.message || "Analyzing video...",
                    "processing"
                  );
                  progressBar.style.width = "0%";
                } else if (progressData.stage === "probed_success") {
                  showStatus(
                    progressData.message ||
                      "Analysis complete. Starting conversion...",
                    "processing"
                  );
                  progressBar.style.width = "0%";
                } else if (progressData.stage === "processing") {
                  progressBar.style.width = (progressData.percent || 0) + "%";
                  showStatus(
                    progressData.message ||
                      `Processing... ${progressData.percent || 0}%`,
                    "processing"
                  );
                } else if (progressData.stage === "done") {
                  currentProcessedFilename = progressData.filename;
                  showStatus(
                    progressData.message || "Video processed successfully!",
                    "success"
                  );
                  showNotification(
                    `✅ ${
                      progressData.message || "Video processed successfully!"
                    }`
                  );
                  progressBar.style.width = "100%";
                  progressBar.style.background = "#22c55e";
                  sseEventSource.close();
                  handleRenameAndFinalize();
                } else if (progressData.stage === "error") {
                  showStatus(
                    `Error: ${progressData.error || "Processing failed"}`,
                    "error"
                  );
                  showNotification(
                    `❌ ${
                      progressData.error ||
                      "An error occurred during processing."
                    }`,
                    true
                  );
                  progressBar.style.background = "#ef4444";
                  sseEventSource.close();
                  resetFormState();
                }
              };

              sseEventSource.onerror = function () {
                showStatus(
                  "Error connecting to processing status updates.",
                  "error"
                );
                showNotification(
                  "🔌 Connection error with server for status updates.",
                  true
                );
                progressBar.style.background = "#ef4444";
                sseEventSource.close();
                resetFormState();
              };
            } else {
              showStatus(
                "Error: Could not initialize video processing.",
                "error"
              );
              showNotification(
                `❌ ${response.message || "Failed to start processing."}`,
                true
              );
              progressBar.style.background = "#ef4444";
              resetFormState();
            }
          } catch (parseError) {
            console.error(
              "Parse error:",
              parseError,
              "Response text:",
              xhr.responseText
            );
            showStatus("Error processing server response", "error");
            showNotification("❌ Error processing server response", true);
            progressBar.style.background = "#ef4444";
            resetFormState();
          }
        };

        xhr.onerror = function () {
          showStatus("❌ Connection error during upload", "error");
          showNotification("🔌 Connection error with server", true);
          progressBar.style.background = "#ef4444";
          resetFormState();
        };

        xhr.send(formData);
      });

      async function handleRenameAndFinalize() {
        const customName = customNameInput.value.trim();
        if (customName && currentProcessedFilename) {
          showStatus("Renaming file...", "processing");
          try {
            const renameRes = await fetch("/rename", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: passwordInput.value,
              },
              body: JSON.stringify({
                original: currentProcessedFilename,
                newName: customName,
              }),
            });

            if (renameRes.status === 401) {
              const renameAuthError = await renameRes.json();
              if (renameAuthError.error === "WRONG_PASSWORD")
                handleAuthError(
                  "WRONG_PASSWORD",
                  "❌ Wrong password for renaming"
                );
              else handleAuthError("AUTH_ERROR", "🚫 Auth error during rename");
              showStatus("❌ Rename auth failed", "error");
              submitBtn.disabled = false;
              submitBtn.innerHTML = "<span>📤 Upload Video</span>";
              return;
            }

            const renameResponse = await renameRes.json();
            if (renameResponse.success) {
              showNotification(`📝 ${renameResponse.message}`);
              currentProcessedFilename = renameResponse.newName;
            } else {
              showNotification(
                `⚠️ Error renaming: ${renameResponse.error}`,
                true
              );
            }
          } catch (renameError) {
            console.error("Rename fetch error:", renameError);
            showNotification(
              "⚠️ Network error while trying to rename file",
              true
            );
          }
        }

        await loadVideos();
        setTimeout(() => {
          resetFormState();
        }, 2000);
      }

      function showStatus(message, type) {
        status.textContent = message;
        status.className = `status-${type}`;
        status.style.display = "block";
      }

      function hideStatus() {
        status.style.display = "none";
      }

      function showNotification(msg, isError = false, errorType = null) {
        notification.textContent = msg;
        notification.className = "";
        if (isError) {
          notification.className =
            errorType === "auth"
              ? "notification-auth-error"
              : "notification-error";
        } else {
          notification.className = "notification-success";
        }
        notification.style.display = "block";
        setTimeout(() => {
          notification.style.display = "none";
          notification.className = "";
        }, 5000);
      }

      async function loadVideos() {
        try {
          const res = await fetch("/videos");
          if (!res.ok) {
            throw new Error(`Failed to load videos: ${res.statusText}`);
          }
          const videos = await res.json();
          const container = document.getElementById("videoList");

          if (videos.length === 0) {
            container.innerHTML =
              '<div class="no-videos">📂 No videos uploaded yet</div>';
            return;
          }

          container.innerHTML = "";

          videos.forEach((video) => {
            const videoItem = document.createElement("div");
            videoItem.className = "video-item";

            const thumbnailDiv = document.createElement("div");
            thumbnailDiv.className = "video-thumbnail";

            // Create play overlay
            const playOverlay = document.createElement("div");
            playOverlay.className = "play-overlay";
            playOverlay.innerHTML = "▶️";

            if (video.thumbnail) {
              // Show thumbnail image
              const thumbnailImg = document.createElement("img");
              thumbnailImg.src = `/thumbnail/${encodeURIComponent(
                video.thumbnail
              )}`;
              thumbnailImg.alt = `Thumbnail for ${video.filename}`;
              thumbnailImg.onerror = function () {
                // Fallback if thumbnail fails to load
                this.style.display = "none";
                const placeholder = document.createElement("div");
                placeholder.className = "placeholder";
                placeholder.textContent = "🎬";
                thumbnailDiv.appendChild(placeholder);
              };
              thumbnailDiv.appendChild(thumbnailImg);
            } else {
              // Show placeholder
              const placeholder = document.createElement("div");
              placeholder.className = "placeholder";
              placeholder.textContent = "🎬";
              thumbnailDiv.appendChild(placeholder);
            }

            thumbnailDiv.appendChild(playOverlay);

            const videoInfo = document.createElement("div");
            videoInfo.className = "video-info";

            const videoLink = document.createElement("a");
            videoLink.href = `/video/${encodeURIComponent(video.filename)}`;
            videoLink.target = "_blank";
            videoLink.className = "video-title";
            videoLink.textContent = video.filename;

            videoInfo.appendChild(videoLink);

            // Make entire video item clickable
            videoItem.addEventListener("click", (e) => {
              if (e.target.tagName !== "A") {
                videoLink.click();
              }
            });

            videoItem.appendChild(thumbnailDiv);
            videoItem.appendChild(videoInfo);
            container.appendChild(videoItem);
          });
        } catch (error) {
          console.error("Error loading videos:", error);
          showNotification(
            `❌ Error loading video list: ${error.message}`,
            true
          );
        }
      }

      // Load videos on page load
      loadVideos();
    </script>
  </body>
</html>
